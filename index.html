<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RolePlay Chat - AI è§’è‰²æ‰®æ¼”</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', 'PingFang SC', sans-serif; }
        .chat-container { height: calc(100vh - 180px); }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        .message-content p { margin-bottom: 0.5rem; }
        .message-content p:last-child { margin-bottom: 0; }
        .role-card.active { border-color: #3b82f6; background-color: #eff6ff; }
    </style>
</head>
<body class="bg-gray-50 text-gray-900">
    <!-- Login Overlay -->
    <div id="loginOverlay" class="fixed inset-0 bg-white z-[100] flex items-center justify-center">
        <div class="bg-white p-8 rounded-2xl shadow-xl border border-gray-100 w-full max-w-sm text-center">
            <div class="w-16 h-16 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-6 text-2xl">
                <i class="fas fa-lock"></i>
            </div>
            <h2 class="text-2xl font-bold mb-2">æ¬¢è¿å›æ¥</h2>
            <p class="text-gray-500 mb-6 text-sm">è¯·è¾“å…¥è®¿é—®å¯†ç ä»¥ç»§ç»­</p>
            <form id="loginForm" class="space-y-4">
                <input type="password" id="loginPassword" placeholder="è®¿é—®å¯†ç " 
                       class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition-all">
                <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-xl font-semibold hover:bg-blue-700 transition-colors shadow-lg shadow-blue-200">
                    ç™»å½•
                </button>
            </form>
            <p id="loginError" class="text-red-500 text-xs mt-4 hidden">å¯†ç ä¸æ­£ç¡®ï¼Œè¯·é‡è¯•</p>
        </div>
    </div>

    <div class="max-w-6xl mx-auto h-screen flex flex-col p-4">
        <!-- Header -->
        <header class="flex justify-between items-center mb-6 px-4">
            <h1 class="text-2xl font-bold text-blue-600"><i class="fas fa-mask mr-2"></i>RolePlay Chat</h1>
            <button id="settingsBtn" class="p-2 rounded-full hover:bg-gray-200 transition-colors">
                <i class="fas fa-cog text-xl text-gray-600"></i>
            </button>
        </header>

        <div class="flex flex-1 gap-6 overflow-hidden">
            <!-- Sidebar: Roles -->
            <aside class="w-1/4 flex flex-col gap-4 overflow-y-auto pr-2 scrollbar-hide">
                <div class="flex justify-between items-center">
                    <h2 class="font-semibold text-gray-700">è§’è‰²é€‰æ‹©</h2>
                    <button id="addRoleBtn" class="text-sm text-blue-600 hover:text-blue-800"><i class="fas fa-plus mr-1"></i>åˆ›å»º</button>
                </div>
                <div id="roleList" class="flex flex-col gap-3">
                    <!-- Roles will be injected here -->
                </div>
            </aside>

            <!-- Main Chat Area -->
            <main class="flex-1 flex flex-col bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
                <!-- Chat Header -->
                <div id="activeRoleHeader" class="p-4 border-b border-gray-100 bg-gray-50 flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 font-bold">
                        ?
                    </div>
                    <div class="flex-1">
                        <h3 class="font-bold text-gray-800" id="activeRoleName">è¯·é€‰æ‹©è§’è‰²</h3>
                        <p class="text-xs text-gray-500" id="activeRoleDesc">å¼€å§‹æ‚¨çš„å¯¹è¯</p>
                    </div>
                    <button id="clearChatBtn" class="p-2 text-gray-400 hover:text-red-500 transition-colors hidden" title="æ¸…ç©ºå½“å‰å¯¹è¯">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>

                <!-- Messages -->
                <div id="chatMessages" class="flex-1 overflow-y-auto p-6 flex flex-col gap-4 chat-container">
                    <div class="text-center text-gray-400 mt-10">
                        <i class="fas fa-comments text-4xl mb-4"></i>
                        <p>é€‰æ‹©ä¸€ä¸ªè§’è‰²å¼€å§‹èŠå¤©å§</p>
                    </div>
                </div>

                <!-- Input Area -->
                <div class="p-4 border-t border-gray-100">
                    <form id="chatForm" class="flex gap-2 items-center">
                        <button type="button" id="voiceBtn" 
                                class="w-10 h-10 flex items-center justify-center rounded-full bg-gray-100 hover:bg-blue-100 text-gray-500 hover:text-blue-600 transition-all disabled:opacity-50"
                                disabled title="è¯­éŸ³è¾“å…¥">
                            <i class="fas fa-microphone"></i>
                        </button>
                        <input type="text" id="userInput" placeholder="è¾“å…¥æ¶ˆæ¯..." 
                               class="flex-1 px-4 py-2 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-gray-100" 
                               disabled>
                        <button type="submit" id="sendBtn" 
                                class="bg-blue-600 text-white px-6 py-2 rounded-xl hover:bg-blue-700 transition-colors disabled:bg-gray-400" 
                                disabled>
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </form>
                    <div id="recordingStatus" class="hidden text-center mt-2">
                        <span class="inline-flex items-center px-3 py-1 rounded-full bg-red-100 text-red-600 text-xs font-medium animate-pulse">
                            <i class="fas fa-circle mr-2"></i> æ­£åœ¨å½•éŸ³... ç‚¹å‡»æŒ‰é’®åœæ­¢
                        </span>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-6 w-full max-w-md shadow-xl">
            <h2 class="text-xl font-bold mb-4">API è®¾ç½®</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">OpenRouter API Key</label>
                    <div class="flex gap-2">
                        <input type="password" id="apiKeyInput" placeholder="sk-or-v1-..." 
                               class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                        <button id="verifyKey" class="px-3 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm transition-colors">éªŒè¯å¹¶åŠ è½½</button>
                    </div>
                    <p class="text-xs text-gray-400 mt-1">Key å°†ä¿å­˜åœ¨æ‚¨çš„æµè§ˆå™¨æœ¬åœ°å­˜å‚¨ä¸­</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">é€‰æ‹©æ¨¡å‹</label>
                    <input type="text" id="modelSearch" placeholder="æœç´¢æ¨¡å‹ (å¦‚: gpt-4, claude)..." 
                           class="w-full px-4 py-2 border border-gray-300 rounded-t-lg focus:ring-2 focus:ring-blue-500 outline-none border-b-0 text-sm">
                    <select id="modelSelect" size="5" class="w-full px-2 py-1 border border-gray-300 rounded-b-lg focus:ring-2 focus:ring-blue-500 outline-none bg-white">
                        <option value="openai/gpt-3.5-turbo">Loading models...</option>
                    </select>
                    <button id="refreshModels" class="text-xs text-blue-600 mt-1 hover:underline">åˆ·æ–°æ¨¡å‹åˆ—è¡¨</button>
                </div>
                <hr class="border-gray-100">
                <div class="space-y-3">
                    <h3 class="text-sm font-bold text-gray-800">ç«å±±å¼•æ“è¯­éŸ³è¯†åˆ«è®¾ç½® (ASR)</h3>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">AppID</label>
                        <input type="text" id="volcAppId" placeholder="ç«å±±å¼•æ“ AppID" 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Access Token</label>
                        <input type="password" id="volcToken" placeholder="ç«å±±å¼•æ“ Access Token" 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                </div>
                <div class="flex justify-end gap-3 mt-6">
                    <button id="closeSettings" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">å…³é—­</button>
                    <button id="saveSettings" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">ä¿å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Role Modal -->
    <div id="roleModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-6 w-full max-w-md shadow-xl">
            <h2 class="text-xl font-bold mb-4">åˆ›å»ºæ–°è§’è‰²</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">è§’è‰²åç§°</label>
                    <input type="text" id="newRoleName" placeholder="ä¾‹å¦‚ï¼šç¦å°”æ‘©æ–¯" 
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">è§’è‰²æè¿° (ç®€çŸ­)</label>
                    <input type="text" id="newRoleDesc" placeholder="ä¾‹å¦‚ï¼šä¼Ÿå¤§çš„ä¾¦æ¢" 
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">æç¤ºè¯ (System Prompt)</label>
                    <textarea id="newRolePrompt" rows="4" placeholder="æè¿°è§’è‰²çš„æ€§æ ¼ã€è¯´è¯æ–¹å¼å’ŒèƒŒæ™¯..." 
                              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"></textarea>
                </div>
                <div class="flex justify-end gap-3 mt-6">
                    <button id="closeRoleModal" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">å–æ¶ˆ</button>
                    <button id="saveRole" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">ä¿å­˜è§’è‰²</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // State Management
        const state = {
            apiKey: localStorage.getItem('openrouter_api_key') || '',
            selectedModel: localStorage.getItem('selected_model') || 'x-ai/grok-4.1-fast',
            volcAppId: localStorage.getItem('volc_appid') || '',
            volcToken: localStorage.getItem('volc_token') || '',
            allModels: [], // Store all fetched models for filtering
            roles: [
                { id: 'coach', name: 'ä¸“ä¸šå¥èº«æ•™ç»ƒ', desc: 'å……æ»¡åŠ¨åŠ›çš„ç§‘å­¦æŒ‡å¯¼è€…', prompt: 'You are a professional fitness coach with 10 years of experience. You are enthusiastic, positive, and speak with high motivation. You provide scientific training advice and nutritional guidance while constantly encouraging the user to persevere. Your responses should be professional, practical, and full of positive energy. Please respond in Chinese.', icon: 'ğŸ’ª' },
                { id: 'bartender', name: 'èµ›åšæœ‹å…‹è°ƒé…’å¸ˆ', desc: 'åä¹Œæ‰˜é‚¦ä¸–ç•Œçš„å€¾å¬è€…', prompt: 'You are a bartender under the neon lights of a cyberpunk metropolis in the year 2077. You have seen the highs and lows of human nature and speak with a hint of world-weariness and humor. You are an excellent listener, chatting with customers about life, technology, and this broken world while wiping glasses. Your responses should be emotional and carry a sci-fi atmosphere. Please respond in Chinese.', icon: 'ğŸ¸' },
                ...(JSON.parse(localStorage.getItem('custom_roles')) || [])
            ],
            currentRoleId: null,
            chatHistory: JSON.parse(localStorage.getItem('chat_history')) || {} // roleId -> messages[]
        };

        // DOM Elements
        const elements = {
            loginOverlay: document.getElementById('loginOverlay'),
            loginForm: document.getElementById('loginForm'),
            loginPassword: document.getElementById('loginPassword'),
            loginError: document.getElementById('loginError'),

            settingsBtn: document.getElementById('settingsBtn'),
            settingsModal: document.getElementById('settingsModal'),
            closeSettings: document.getElementById('closeSettings'),
            saveSettings: document.getElementById('saveSettings'),
            apiKeyInput: document.getElementById('apiKeyInput'),
            verifyKey: document.getElementById('verifyKey'),
            modelSearch: document.getElementById('modelSearch'),
            modelSelect: document.getElementById('modelSelect'),
            refreshModels: document.getElementById('refreshModels'),
            
            roleList: document.getElementById('roleList'),
            addRoleBtn: document.getElementById('addRoleBtn'),
            roleModal: document.getElementById('roleModal'),
            closeRoleModal: document.getElementById('closeRoleModal'),
            saveRole: document.getElementById('saveRole'),
            newRoleName: document.getElementById('newRoleName'),
            newRoleDesc: document.getElementById('newRoleDesc'),
            newRolePrompt: document.getElementById('newRolePrompt'),

            chatMessages: document.getElementById('chatMessages'),
            chatForm: document.getElementById('chatForm'),
            userInput: document.getElementById('userInput'),
            sendBtn: document.getElementById('sendBtn'),
            voiceBtn: document.getElementById('voiceBtn'),
            recordingStatus: document.getElementById('recordingStatus'),
            volcAppId: document.getElementById('volcAppId'),
            volcToken: document.getElementById('volcToken'),
            activeRoleName: document.getElementById('activeRoleName'),
            activeRoleDesc: document.getElementById('activeRoleDesc'),
            activeRoleHeader: document.getElementById('activeRoleHeader'),
            clearChatBtn: document.getElementById('clearChatBtn')
        };

        // Initialize
        async function init() {
            // Check backend auth status
            try {
                const resp = await fetch('/api/check-auth');
                const data = await resp.json();
                if (data.isLoggedIn) {
                    elements.loginOverlay.classList.add('hidden');
                }
            } catch (e) {
                console.log('Running in local mode');
            }

            renderRoles();
            elements.apiKeyInput.value = state.apiKey;
            elements.volcAppId.value = state.volcAppId;
            elements.volcToken.value = state.volcToken;
            if (state.apiKey) {
                fetchModels();
            }
            setupEventListeners();
        }

        function setupEventListeners() {
            elements.loginForm.onsubmit = async (e) => {
                e.preventDefault();
                const pass = elements.loginPassword.value;
                
                try {
                    const resp = await fetch('/api/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ password: pass })
                    });
                    
                    if (resp.ok) {
                        elements.loginOverlay.classList.add('hidden');
                    } else {
                        elements.loginError.classList.remove('hidden');
                        elements.loginPassword.value = '';
                    }
                } catch (err) {
                    // Fallback for direct file opening
                    if (pass === '888') {
                        elements.loginOverlay.classList.add('hidden');
                    } else {
                        elements.loginError.classList.remove('hidden');
                    }
                }
            };

            elements.settingsBtn.onclick = () => {
                elements.apiKeyInput.value = state.apiKey;
                elements.settingsModal.classList.remove('hidden');
            };
            elements.closeSettings.onclick = () => elements.settingsModal.classList.add('hidden');
            elements.saveSettings.onclick = () => {
                state.apiKey = elements.apiKeyInput.value;
                state.selectedModel = elements.modelSelect.value;
                state.volcAppId = elements.volcAppId.value;
                state.volcToken = elements.volcToken.value;
                localStorage.setItem('openrouter_api_key', state.apiKey);
                localStorage.setItem('selected_model', state.selectedModel);
                localStorage.setItem('volc_appid', state.volcAppId);
                localStorage.setItem('volc_token', state.volcToken);
                elements.settingsModal.classList.add('hidden');
                checkInputs();
            };

            elements.verifyKey.onclick = () => {
                state.apiKey = elements.apiKeyInput.value;
                fetchModels();
            };
            elements.refreshModels.onclick = fetchModels;

            elements.modelSearch.oninput = () => {
                const term = elements.modelSearch.value.toLowerCase();
                renderModelOptions(state.allModels.filter(m => 
                    m.id.toLowerCase().includes(term) || 
                    (m.name && m.name.toLowerCase().includes(term))
                ));
            };

            elements.addRoleBtn.onclick = () => elements.roleModal.classList.remove('hidden');
            elements.closeRoleModal.onclick = () => elements.roleModal.classList.add('hidden');
            elements.saveRole.onclick = createRole;

            elements.chatForm.onsubmit = (e) => {
                e.preventDefault();
                sendMessage();
            };

            elements.clearChatBtn.onclick = () => {
                if (state.currentRoleId && confirm('ç¡®å®šè¦æ¸…ç©ºä¸å½“å‰è§’è‰²çš„å¯¹è¯è®°å½•å—ï¼Ÿ')) {
                    state.chatHistory[state.currentRoleId] = [];
                    saveChatHistory();
                    renderMessages();
                }
            };

            // Voice Recognition Logic
            let mediaRecorder;
            let audioChunks = [];

            elements.voiceBtn.onclick = async () => {
                if (mediaRecorder && mediaRecorder.state === 'recording') {
                    mediaRecorder.stop();
                    elements.recordingStatus.classList.add('hidden');
                    elements.voiceBtn.classList.remove('bg-red-500', 'text-white');
                    return;
                }

                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];

                    mediaRecorder.ondataavailable = (event) => {
                        audioChunks.push(event.data);
                    };

                    mediaRecorder.onstop = async () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                        await handleVoiceUpload(audioBlob);
                        stream.getTracks().forEach(track => track.stop());
                    };

                    mediaRecorder.start();
                    elements.recordingStatus.classList.remove('hidden');
                    elements.voiceBtn.classList.add('bg-red-500', 'text-white');
                } catch (err) {
                    alert('æ— æ³•è®¿é—®éº¦å…‹é£ï¼Œè¯·ç¡®ä¿å·²æˆäºˆæƒé™ã€‚');
                    console.error(err);
                }
            };

            async function handleVoiceUpload(blob) {
                if (!state.volcAppId || !state.volcToken) {
                    alert('è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½®ç«å±±å¼•æ“ AppID å’Œ Access Token');
                    return;
                }

                elements.userInput.placeholder = "æ­£åœ¨è¯†åˆ«è¯­éŸ³...";
                elements.userInput.disabled = true;

                const formData = new FormData();
                formData.append('audio', blob);
                formData.append('appid', state.volcAppId);
                formData.append('token', state.volcToken);

                try {
                    const resp = await fetch('/api/asr', {
                        method: 'POST',
                        body: formData
                    });
                    const data = await resp.json();
                    if (data.text) {
                        elements.userInput.value = data.text;
                    } else {
                        alert('è¯†åˆ«å¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'));
                    }
                } catch (err) {
                    console.error(err);
                    alert('è¯†åˆ«è¿‡ç¨‹ä¸­å‘ç”Ÿç½‘ç»œé”™è¯¯');
                } finally {
                    elements.userInput.disabled = false;
                    elements.userInput.placeholder = "è¾“å…¥æ¶ˆæ¯...";
                }
            }
        }

        function saveChatHistory() {
            localStorage.setItem('chat_history', JSON.stringify(state.chatHistory));
        }

        async function fetchModels() {
            const keyToUse = elements.apiKeyInput.value || state.apiKey;
            if (!keyToUse) {
                alert('è¯·å…ˆè¾“å…¥ API Key');
                return;
            }
            elements.modelSelect.innerHTML = '<option>æ­£åœ¨è·å–æ¨¡å‹...</option>';
            try {
                const response = await fetch('https://openrouter.ai/api/v1/models', {
                    headers: { 'Authorization': `Bearer ${keyToUse}` }
                });
                const data = await response.json();
                if (data.data && Array.isArray(data.data)) {
                    state.allModels = data.data;
                    renderModelOptions(state.allModels);
                } else {
                    throw new Error('API è¿”å›æ ¼å¼é”™è¯¯');
                }
            } catch (error) {
                console.error(error);
                const fallbackModels = [
                    { id: 'x-ai/grok-4.1-fast', name: 'Grok 4.1 Fast' },
                    { id: 'x-ai/grok-2-1212', name: 'Grok 2 (1212)' },
                    { id: 'google/gemini-flash-1.5', name: 'Gemini Flash 1.5' }
                ];
                state.allModels = fallbackModels;
                renderModelOptions(fallbackModels);
                alert('è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥ API Key æ˜¯å¦æ­£ç¡®ã€‚å·²åŠ è½½å¸¸ç”¨å¤‡é€‰åˆ—è¡¨ã€‚');
            }
        }

        function renderModelOptions(models) {
            elements.modelSelect.innerHTML = '';
            models.forEach(model => {
                const option = document.createElement('option');
                option.value = model.id;
                option.textContent = model.name || model.id;
                option.className = "py-1 px-2 hover:bg-blue-50";
                if (model.id === state.selectedModel) option.selected = true;
                elements.modelSelect.appendChild(option);
            });
            if (models.length === 0) {
                elements.modelSelect.innerHTML = '<option disabled>æœªæ‰¾åˆ°åŒ¹é…æ¨¡å‹</option>';
            }
        }

        function renderRoles() {
            elements.roleList.innerHTML = '';
            state.roles.forEach(role => {
                const isCustom = String(role.id).startsWith('custom-');
                const div = document.createElement('div');
                div.className = `role-card p-3 border border-gray-200 rounded-xl cursor-pointer hover:shadow-md transition-all flex items-center gap-3 relative group ${state.currentRoleId === role.id ? 'active' : ''}`;
                
                // Content container to separate click area from delete button
                const contentDiv = document.createElement('div');
                contentDiv.className = 'flex items-center gap-3 flex-1 overflow-hidden';
                contentDiv.onclick = () => selectRole(role.id);
                contentDiv.innerHTML = `
                    <div class="text-2xl">${role.icon || 'ğŸ‘¤'}</div>
                    <div class="flex-1 overflow-hidden">
                        <div class="font-bold text-sm truncate">${role.name}</div>
                        <div class="text-xs text-gray-500 truncate">${role.desc}</div>
                    </div>
                `;
                div.appendChild(contentDiv);

                if (isCustom) {
                    const delBtn = document.createElement('div'); // Changed from button to div to avoid potential default form submission or button behaviors
                    delBtn.className = 'absolute right-2 top-2 text-gray-400 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-all cursor-pointer z-50 p-1 bg-white rounded-full shadow-sm';
                    delBtn.innerHTML = '<i class="fas fa-times-circle text-xl"></i>';
                    delBtn.title = 'åˆ é™¤è§’è‰²';
                    
                    // Use addEventListener for more robust event handling
                    delBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('Delete clicked for role:', role.id); // Debug log
                        deleteRole(role.id);
                    });
                    
                    div.appendChild(delBtn);
                }
                
                elements.roleList.appendChild(div);
            });
        }

        function deleteRole(roleId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè§’è‰²å—ï¼Ÿç›¸å…³çš„å¯¹è¯è®°å½•ä¹Ÿå°†è¢«æ¸…é™¤ã€‚')) return;
            
            // 1. Update state first
            state.roles = state.roles.filter(r => r.id !== roleId);
            delete state.chatHistory[roleId];
            
            // 2. Persist to localStorage
            saveChatHistory();
            const customRoles = state.roles.filter(r => String(r.id).startsWith('custom-'));
            localStorage.setItem('custom_roles', JSON.stringify(customRoles));
            
            // 3. Update UI
            if (state.currentRoleId === roleId) {
                state.currentRoleId = null;
                elements.activeRoleName.textContent = 'è¯·é€‰æ‹©è§’è‰²';
                elements.activeRoleDesc.textContent = 'å¼€å§‹æ‚¨çš„å¯¹è¯';
                elements.activeRoleHeader.querySelector('div').textContent = '?';
                elements.clearChatBtn.classList.add('hidden');
                renderMessages(); // Clear messages view
            }
            
            // 4. Force re-render of role list immediately
            setTimeout(() => {
                renderRoles();
                checkInputs();
            }, 0);
        }

        function createRole() {
            const name = elements.newRoleName.value.trim();
            const desc = elements.newRoleDesc.value.trim();
            const prompt = elements.newRolePrompt.value.trim();
            if (!name || !prompt) return alert('è¯·å¡«å†™åç§°å’Œæç¤ºè¯');

            const newRole = {
                id: 'custom-' + Date.now(),
                name, desc, prompt, icon: 'âœ¨'
            };
            state.roles.push(newRole);
            localStorage.setItem('custom_roles', JSON.stringify(state.roles.filter(r => r.id.startsWith('custom-'))));
            renderRoles();
            elements.roleModal.classList.add('hidden');
            // Clear inputs
            elements.newRoleName.value = '';
            elements.newRoleDesc.value = '';
            elements.newRolePrompt.value = '';
        }

        function selectRole(roleId) {
            state.currentRoleId = roleId;
            const role = state.roles.find(r => r.id === roleId);
            elements.activeRoleName.textContent = role.name;
            elements.activeRoleDesc.textContent = role.desc;
            elements.activeRoleHeader.querySelector('div').textContent = role.icon || 'ğŸ‘¤';
            elements.clearChatBtn.classList.remove('hidden');
            
            renderRoles();
            renderMessages();
            checkInputs();
        }

        function checkInputs() {
            const isReady = state.apiKey && state.currentRoleId;
            elements.userInput.disabled = !isReady;
            elements.sendBtn.disabled = !isReady;
            elements.voiceBtn.disabled = !state.currentRoleId;
            
            if (!state.apiKey) {
                elements.userInput.placeholder = "è¯·å…ˆè®¾ç½® API Key...";
            } else if (!state.currentRoleId) {
                elements.userInput.placeholder = "è¯·é€‰æ‹©ä¸€ä¸ªè§’è‰²...";
            } else {
                elements.userInput.placeholder = "è¾“å…¥æ¶ˆæ¯...";
            }
        }

        function renderMessages() {
            elements.chatMessages.innerHTML = '';
            const messages = state.chatHistory[state.currentRoleId] || [];
            if (messages.length === 0) {
                elements.chatMessages.innerHTML = `
                    <div class="text-center text-gray-400 mt-10">
                        <p>ä¸ <b>${state.roles.find(r => r.id === state.currentRoleId).name}</b> çš„å¯¹è¯å¼€å§‹äº†</p>
                    </div>
                `;
                return;
            }

            messages.forEach(msg => {
                const isUser = msg.role === 'user';
                const div = document.createElement('div');
                div.className = `flex ${isUser ? 'justify-end' : 'justify-start'}`;
                div.innerHTML = `
                    <div class="max-w-[80%] rounded-2xl p-3 ${isUser ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-800 shadow-sm'} message-content">
                        ${marked.parse(msg.content)}
                    </div>
                `;
                elements.chatMessages.appendChild(div);
            });
            elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;
        }

        async function sendMessage() {
            const content = elements.userInput.value.trim();
            if (!content || !state.apiKey || !state.currentRoleId) return;

            const role = state.roles.find(r => r.id === state.currentRoleId);
            if (!state.chatHistory[state.currentRoleId]) {
                state.chatHistory[state.currentRoleId] = [];
            }

            // Add user message
            state.chatHistory[state.currentRoleId].push({ role: 'user', content });
            elements.userInput.value = '';
            renderMessages();

            // Prepare API call with Context Isolation
            const messages = [
                { role: 'system', content: role.prompt },
                ...state.chatHistory[state.currentRoleId].filter(m => m.content !== '...')
            ];

            // Add placeholder for AI response
            const aiMsg = { role: 'assistant', content: '...' };
            state.chatHistory[state.currentRoleId].push(aiMsg);
            renderMessages();

            try {
                const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${state.apiKey}`,
                        'Content-Type': 'application/json',
                        'HTTP-Referer': window.location.href,
                        'X-Title': 'Chat'
                    },
                    body: JSON.stringify({
                        model: state.selectedModel,
                        messages: messages
                    })
                });

                const data = await response.json();
                if (data.choices && data.choices[0]) {
                    aiMsg.content = data.choices[0].message.content;
                } else if (data.error) {
                    aiMsg.content = `é”™è¯¯: ${data.error.message || 'æœªçŸ¥é”™è¯¯'}`;
                } else {
                    aiMsg.content = "æŠ±æ­‰ï¼Œæˆ‘æ— æ³•å“åº”ã€‚è¯·æ£€æŸ¥æ‚¨çš„è®¾ç½®ã€‚";
                }
                saveChatHistory();
            } catch (error) {
                aiMsg.content = "ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚";
                console.error(error);
            }
            renderMessages();
        }

        init();
    </script>
</body>
</html>
